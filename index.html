<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Luxury Tree - Custom Edition</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Ma+Shan+Zheng&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #020205; 
            font-family: 'Cinzel', serif; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        
        #canvas-container { 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            z-index: 1; 
        }
        
        #ui-layer { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            pointer-events: none; 
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.3) 100%); 
        }
        
        #main-title {
            position: absolute;
            top: max(10%, env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            font-family: 'Cinzel', serif;
            font-weight: 800;
            font-size: clamp(24px, 5vw, 60px);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            pointer-events: none;
            z-index: 20;
            opacity: 0;
            min-height: 1.2em;
            padding: 0 20px;
            box-sizing: border-box;
            
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(180deg, #fffdf0 0%, #eacda3 30%, #d6ae7b 60%, #8b6c42 100%);
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.6));
            
            animation: titleFadeIn 2s ease-out forwards 1s;
            transition: filter 1.5s ease, background-image 1.5s ease;
        }

        @keyframes titleFadeIn {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        #loader { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 1.2s; 
            pointer-events: none; 
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 2px solid rgba(212, 175, 55, 0.1); 
            border-top: 2px solid #d4af37; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿é€‚é… */
        #top-right-controls { 
            position: absolute; 
            top: max(20px, env(safe-area-inset-top));
            right: max(20px, env(safe-area-inset-right));
            z-index: 30; 
            display: flex; 
            flex-direction: column;
            gap: 12px;
            pointer-events: auto; 
            align-items: flex-end;
        }
        
        /* ç§»åŠ¨ç«¯æŒ‰é’®æ ·å¼ */
        .control-btn { 
            background: rgba(10, 10, 10, 0.8); 
            border: 1px solid rgba(212, 175, 55, 0.4); 
            color: #d4af37; 
            width: 120px;
            height: 44px;
            padding: 5px 0; 
            border-radius: 10px; 
            font-family: 'Cinzel', serif; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            backdrop-filter: blur(5px); 
            transition: all 0.3s ease; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .control-btn {
                width: 100px;
                height: 40px;
                font-size: 13px;
                padding: 4px 0;
            }
            
            #top-right-controls {
                top: max(15px, env(safe-area-inset-top));
                right: max(15px, env(safe-area-inset-right));
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .control-btn {
                width: 90px;
                height: 36px;
                font-size: 12px;
                padding: 3px 0;
            }
            
            #main-title {
                font-size: clamp(20px, 4vw, 36px);
                top: max(8%, env(safe-area-inset-top));
            }
        }
        
        .control-btn:hover { 
            background: rgba(212, 175, 55, 0.2); 
            border-color: rgba(212, 175, 55, 0.8); 
            color: #fff; 
            transform: scale(1.05); 
        }
        .control-btn:active { 
            transform: scale(0.95); 
            background: rgba(212, 175, 55, 0.3); 
        }
        .control-btn.disabled { 
            color: #666; 
            border-color: #444; 
        }
        
        #file-input, #music-input, #import-input { display: none; }

        /* ç§»åŠ¨ç«¯æ‘„åƒå¤´é¢„è§ˆé€‚é… */
        #webcam-wrapper { 
            position: absolute; 
            bottom: max(20px, env(safe-area-inset-bottom));
            right: max(20px, env(safe-area-inset-right));
            opacity: 0; 
            pointer-events: none; 
            border: 1px solid rgba(212, 175, 55, 0.5); 
            border-radius: 4px; 
            background: #000; 
            z-index: 50; 
            display: flex; 
            transition: opacity 0.5s;
            width: 160px;
            height: 120px;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            #webcam-wrapper {
                width: 140px;
                height: 105px;
                bottom: max(15px, env(safe-area-inset-bottom));
                right: max(15px, env(safe-area-inset-right));
            }
        }
        
        @media (max-width: 480px) {
            #webcam-wrapper {
                width: 120px;
                height: 90px;
                bottom: max(10px, env(safe-area-inset-bottom));
                right: max(10px, env(safe-area-inset-right));
            }
        }
        
        #webcam { display: none; }
        #webcam-preview { 
            width: 100%; 
            height: 100%; 
            transform: scaleX(-1); 
            object-fit: cover;
        }

        /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†é€‚é… */
        #letter-editor-modal { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 90%; 
            max-width: 500px; 
            max-height: 80vh;
            background: rgba(10, 10, 10, 0.95); 
            border: 1px solid #d4af37; 
            border-radius: 10px; 
            padding: 20px; 
            z-index: 200; 
            display: none; 
            flex-direction: column; 
            gap: 15px; 
            pointer-events: auto;
            overflow-y: auto;
        }
        
        #letter-editor-modal h3 { 
            color: #d4af37; 
            margin: 0 0 10px 0; 
            text-align: center; 
            font-size: clamp(18px, 4vw, 22px);
        }
        
        #letter-text-input { 
            width: 100%; 
            height: 200px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid #444; 
            color: #fff; 
            padding: 12px; 
            resize: none; 
            outline: none; 
            font-size: 16px;
            font-family: inherit;
            border-radius: 5px;
        }
        
        @media (max-width: 480px) {
            #letter-text-input {
                height: 150px;
                font-size: 14px;
            }
        }
        
        .modal-btn-group { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }

        /* ç§»åŠ¨ç«¯ä¹¦ä¿¡æŸ¥çœ‹é€‚é… */
        #letter-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 150; 
            background: rgba(0,0,0,0.9); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            pointer-events: auto; 
            opacity: 0; 
            transition: opacity 1.5s ease; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            box-sizing: border-box;
        }
        
        .letter-paper { 
            width: 90%;
            max-width: 800px;
            height: auto;
            max-height: 80vh;
            aspect-ratio: 3/4; 
            background: rgba(255, 252, 240, 0.15); 
            backdrop-filter: blur(3px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            padding: clamp(20px, 4vh, 40px); 
            box-sizing: border-box; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            transform: translateY(20px); 
            transition: transform 1.5s ease-out; 
            overflow: hidden;
        }
        
        .letter-content { 
            font-family: 'Ma Shan Zheng', cursive; 
            font-size: clamp(14px, 2vh, 20px); 
            line-height: 1.6; 
            color: rgba(255, 255, 255, 0.9); 
            text-shadow: 0 0 5px rgba(255,215,0, 0.3); 
            white-space: pre-wrap; 
            overflow-y: auto; 
            flex: 1; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .letter-content::-webkit-scrollbar { 
            width: 6px; 
        }
        .letter-content::-webkit-scrollbar-thumb { 
            background: rgba(212, 175, 55, 0.3); 
            border-radius: 3px; 
        }
        .cursor::after { 
            content: '|'; 
            animation: blink 1s step-end infinite; 
        }
        @keyframes blink { 50% { opacity: 0; } }

        .letter-close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            width: 40px; 
            height: 40px; 
            border: 1px solid rgba(255,255,255,0.4); 
            border-radius: 50%; 
            color: rgba(255,255,255,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-size: 24px;
            z-index: 10;
        }
        
        @media (max-width: 480px) {
            .letter-close-btn {
                width: 36px;
                height: 36px;
                top: 10px;
                right: 10px;
                font-size: 20px;
            }
        }
        
        .letter-close-btn:hover { 
            background: rgba(255,255,255,0.2); 
            color: #fff; 
            border-color: #fff; 
        }
        
        /* ç§»åŠ¨ç«¯æç¤ºä¿¡æ¯ */
        #mobile-alert {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #d4af37;
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.5);
            font-size: 14px;
            text-align: center;
            z-index: 40;
            display: none;
            pointer-events: none;
            backdrop-filter: blur(5px);
            max-width: 90%;
            box-sizing: border-box;
        }
        
        /* ç§»åŠ¨ç«¯æ‰‹åŠ¿æç¤º */
        #gesture-tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #d4af37;
            border-radius: 15px;
            padding: 25px;
            z-index: 300;
            display: none;
            flex-direction: column;
            pointer-events: auto;
            color: #fff;
        }
        
        .tutorial-content h3 {
            color: #d4af37;
            margin: 0 0 20px 0;
            text-align: center;
            font-size: 20px;
        }
        
        .gesture-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .gesture-icon {
            font-size: 32px;
            margin-right: 15px;
            width: 60px;
            text-align: center;
        }
        
        .gesture-desc {
            flex: 1;
            font-size: 16px;
            line-height: 1.4;
        }
        
        #close-tutorial {
            margin-top: 20px;
            align-self: center;
            width: 120px;
        }
        
        /* ç§»åŠ¨ç«¯è§¦æ‘¸æ§åˆ¶åŒºåŸŸ */
        #touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            z-index: 5;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 0 20px 20px 20px;
            box-sizing: border-box;
        }
        
        .touch-zone {
            width: 100px;
            height: 100px;
            pointer-events: auto;
            opacity: 0.1;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.2);
            margin: 0 10px;
        }
        
        @media (max-width: 768px) {
            .touch-zone {
                width: 80px;
                height: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .touch-zone {
                width: 60px;
                height: 60px;
            }
            
            #touch-controls {
                height: 25%;
                padding: 0 10px 10px 10px;
            }
        }
        
        /* é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ */
        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="loader"><div class="spinner"></div></div>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="main-title"></div>

        <div id="top-right-controls">
            <div class="control-col" id="col-media">
                <button id="btn-bg-music" class="control-btn">ä¸Šä¼ éŸ³ä¹</button>
                <button id="btn-add-photo" class="control-btn">ä¸Šä¼ ç…§ç‰‡</button>
                <button id="btn-write-letter" class="control-btn">ä¸Šä¼ ä¹¦ä¿¡</button>
                <button id="btn-set-title" class="control-btn">è®¾ç½®æ ‡é¢˜</button>
            </div>
            <div class="control-col" id="col-system">
                <button id="btn-import" class="control-btn">å¯¼å…¥ç½‘é¡µ</button>
                <button id="btn-export" class="control-btn">å¯¼å‡ºç½‘é¡µ</button>
                <button id="btn-fullscreen" class="control-btn">å…¨å±æ˜¾ç¤º</button>
                <button id="btn-switch-theme" class="control-btn">é¢œè‰²åˆ‡æ¢</button>
            </div>
        </div>
        <input type="file" id="file-input" multiple accept="image/*">
        <input type="file" id="music-input" accept="audio/mp3,audio/*">
        <input type="file" id="import-input" accept=".json">
    </div>

    <!-- ç§»åŠ¨ç«¯æ‰‹åŠ¿æ•™ç¨‹ -->
    <div id="gesture-tutorial">
        <div class="tutorial-content">
            <h3>æ‰‹åŠ¿æ“ä½œæŒ‡å—</h3>
            <div class="gesture-item">
                <div class="gesture-icon">ğŸ‘</div>
                <div class="gesture-desc">ç«–èµ·æ‹‡æŒ‡ä¿æŒ0.5ç§’ - åˆ‡æ¢ä¸»é¢˜</div>
            </div>
            <div class="gesture-item">
                <div class="gesture-icon">ğŸ‘Œ</div>
                <div class="gesture-desc">OKæ‰‹åŠ¿ - æŸ¥çœ‹ä¹¦ä¿¡</div>
            </div>
            <div class="gesture-item">
                <div class="gesture-icon">ğŸ‘</div>
                <div class="gesture-desc">å¼ å¼€æ‰‹æŒ - æ§åˆ¶æ—‹è½¬</div>
            </div>
            <button id="close-tutorial" class="control-btn">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="letter-editor-modal">
        <h3>æ’°å†™ä½ çš„å¿ƒæ„</h3>
        <textarea id="letter-text-input" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³è¯´çš„è¯..."></textarea>
        <div class="modal-btn-group">
            <button id="btn-cancel-letter" class="control-btn" style="width: 80px;">å–æ¶ˆ</button>
            <button id="btn-save-letter" class="control-btn" style="width: 80px;">ä¿å­˜</button>
        </div>
    </div>

    <div id="letter-overlay">
        <div class="letter-paper">
            <div class="letter-close-btn" id="btn-close-letter-mode">Ã—</div>
            <div class="letter-content" id="letter-content-display"></div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æç¤ºä¿¡æ¯ -->
    <div id="mobile-alert"></div>

    <!-- ç§»åŠ¨ç«¯è§¦æ‘¸æ§åˆ¶åŒºåŸŸï¼ˆå¤‡ç”¨ï¼‰ -->
    <div id="touch-controls">
        <div class="touch-zone" id="touch-left"></div>
        <div class="touch-zone" id="touch-right"></div>
    </div>

    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline webkit-playsinline></video>
        <canvas id="webcam-preview"></canvas>
    </div>
    
    <audio id="bg-music" loop crossorigin="anonymous"></audio>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js'; 
        import { FilesetResolver, HandLandmarker, DrawingUtils } from '@mediapipe/tasks-vision';

        const CONFIG = {
            colors: {
                bg: 0x020205, gold: 0xffd700, red: 0x880000, green: 0x004400,
                iceBlue: 0xaaddff, 
                iceCyan: 0x00ffff, 
                iceMagenta: 0xff00cc,
                iceDeep: 0x002244,
                white: 0xffffff,
                barbieHot: 0xff1694,
                barbieSoft: 0xffb7c5,
                barbieViolet: 0xd461e3
            },
            particles: { 
                count: 1200, // å‡å°‘ç§»åŠ¨ç«¯ç²’å­æ•°é‡
                dustCount: 1000, 
                treeHeight: 28, 
                treeRadius: 9,
                snowCount: 1500, // å‡å°‘ç§»åŠ¨ç«¯é›ªèŠ±æ•°é‡
                snowSpeed: 10 
            },
            camera: { z: 55 },
            gestures: { 
                palmOpenThreshold: 0.35, 
                sensitivity: 6.0,
                holdDuration: 500,
                palmSpeedThreshold: 0.05,
                switchCooldown: 2000
            }
        };

        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        const STATE = {
            mode: 'TREE', 
            focusTarget: null, 
            currentPhotoIndex: -1,
            currentThemeIndex: 0, 
            gestureDebounceTimer: 0,
            isGestureSwitchEnabled: true, 
            scatterScale: 1.0, 
            gestureBaseSpread: null,
            hand: { detected: false, x: 0, y: 0 },
            rotation: { x: 0, y: 0 }, 
            spinVel: { x: 0, y: 0 }, 
            time: 0,
            wasPointing: false, 
            palmCenter: { x: 0.5, y: 0.5 }, 
            hasPalmCenter: false,
            starMesh: null, 
            starHaloMesh: null,
            letterContent: "",
            letterTyper: null, 
            letterStartTimer: null, 
            letterLastTriggerTime: 0,
            musicData: null,
            // æ–°å¢ç§»åŠ¨ç«¯çŠ¶æ€
            gestureStartTime: 0,
            lastPalmPosition: null,
            // è§¦æ‘¸æ§åˆ¶çŠ¶æ€
            touchStartX: 0,
            touchStartY: 0,
            touchRotating: false,
            touchVelocity: { x: 0, y: 0 },
            // æ€§èƒ½çŠ¶æ€
            frameCount: 0,
            lastFpsTime: 0,
            fps: 60,
            // ç§»åŠ¨ç«¯æ‘„åƒå¤´çŠ¶æ€
            cameraPermission: null,
            isLandscape: window.innerWidth > window.innerHeight
        };

        let scene, camera, renderer, composer, clock = new THREE.Clock();
        let mainGroup, starGroup, bgGroup, photoMeshGroup, particleSystem = []; 
        let galaxySystem = null; 
        let snowSystem = null;
        let heartSystem = null;

        let handLandmarker, video, drawingUtils, canvasCtx;
        let caneTexture, snowTexture, heartTexture, matLib = {};
        
        const _tempVec = new THREE.Vector3();
        const _targetVec = new THREE.Vector3();
        const _invMatrix = new THREE.Matrix4();

        async function init() {
            // æ˜¾ç¤ºç§»åŠ¨è®¾å¤‡æç¤º
            if (isMobile) {
                showMobileAlert("æ­£åœ¨åŠ è½½3Dåœºæ™¯ï¼Œè¯·ç¨å€™...");
                // å‡å°‘ç§»åŠ¨ç«¯ç²’å­æ•°é‡
                CONFIG.particles.count = 800;
                CONFIG.particles.dustCount = 600;
                CONFIG.particles.snowCount = 1000;
            }
            
            initThree();            
            setupEnvironment();     
            setupLights();          
            createTextures();       
            createMaterials(); 
            
            createGalaxyBackground(); 
            createSnowBackground();
            createHeartBackground();
            
            createParticles();      
            setupPostProcessing();
            setupEvents();          
            setupLetterSystem(); 
            
            // æ˜¾ç¤ºæ‰‹åŠ¿æ•™ç¨‹ï¼ˆä»…ç§»åŠ¨ç«¯ä¸”ç¬¬ä¸€æ¬¡è®¿é—®ï¼‰
            if (isMobile && !localStorage.getItem('tutorialShown')) {
                setTimeout(() => showGestureTutorial(), 2000);
            }
            
            switchTheme(0);

            // åˆå§‹åŒ–MediaPipeï¼ˆç§»åŠ¨ç«¯å¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½è¯·æ±‚æ‘„åƒå¤´æƒé™ï¼‰
            setupMediaPipeWithPermission();

            const loader = document.getElementById('loader');
            loader.style.opacity = 0;
            setTimeout(() => loader.remove(), 1200);
            
            // æ˜¾ç¤ºç§»åŠ¨ç«¯æç¤º
            if (isMobile) {
                setTimeout(() => {
                    showMobileAlert("ä½¿ç”¨æ‰‹åŠ¿æˆ–è§¦æ‘¸å±å¹•æ§åˆ¶åœ£è¯æ ‘", 3000);
                }, 1500);
            }

            animate(); 
        }

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.012); 

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 0, CONFIG.camera.z); 

            // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
            const pixelRatio = isMobile ? Math.min(window.devicePixelRatio, 1.2) : Math.min(window.devicePixelRatio, 1.5);
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: !isMobile, // ç§»åŠ¨ç«¯å…³é—­æŠ—é”¯é½¿æé«˜æ€§èƒ½
                powerPreference: isMobile ? "default" : "high-performance",
                depth: true,
                alpha: false,
                preserveDrawingBuffer: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(pixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping; 
            renderer.toneMappingExposure = 1.0;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            
            // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–è®¾ç½®
            if (isMobile) {
                renderer.physicallyCorrectLights = false;
                renderer.shadowMap.enabled = false;
                renderer.shadowMap.type = THREE.BasicShadowMap;
            }
            
            const canvasContainer = document.getElementById('canvas-container');
            canvasContainer.appendChild(renderer.domElement);
            
            // ç§»åŠ¨ç«¯é˜²æ­¢ä¸Šä¸‹æ–‡ä¸¢å¤±
            renderer.domElement.addEventListener('webglcontextlost', (event) => {
                event.preventDefault();
                showMobileAlert("3Dä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œæ­£åœ¨æ¢å¤...", 2000);
                setTimeout(() => {
                    location.reload();
                }, 1000);
            });

            bgGroup = new THREE.Group(); scene.add(bgGroup);
            mainGroup = new THREE.Group(); mainGroup.rotation.x = 0.1; scene.add(mainGroup);
            starGroup = new THREE.Group(); mainGroup.add(starGroup);
            photoMeshGroup = new THREE.Group(); mainGroup.add(photoMeshGroup);
        }

        function setupEnvironment() {
            if (!isMobile) { // ç§»åŠ¨ç«¯è·³è¿‡ç¯å¢ƒè´´å›¾ä»¥æé«˜æ€§èƒ½
                const pmrem = new THREE.PMREMGenerator(renderer);
                pmrem.compileEquirectangularShader();
                scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
            }
        }

        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));
            const bottomLight = new THREE.PointLight(CONFIG.colors.gold, 3, 40);
            bottomLight.position.set(0, -10, 10);
            mainGroup.add(bottomLight);
            
            // ç§»åŠ¨ç«¯å‡å°‘å…‰æºæ•°é‡
            if (!isMobile) {
                const spotGold = new THREE.SpotLight(0xfff0dd, 800);
                spotGold.position.set(40, 60, 40); spotGold.angle = 0.4; spotGold.decay = 2;
                scene.add(spotGold);
                
                const spotBlue = new THREE.SpotLight(0x4455ff, 400);
                spotBlue.position.set(-40, 10, -30); spotBlue.lookAt(0,0,0);
                scene.add(spotBlue);
            }
        }

        function setupPostProcessing() {
            // ç§»åŠ¨ç«¯å…³é—­åæœŸå¤„ç†ä»¥æé«˜æ€§èƒ½
            if (!isMobile) {
                const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                bloom.threshold = 0.75; bloom.strength = 0.5; bloom.radius = 0.5;
                composer = new EffectComposer(renderer);
                composer.addPass(new RenderPass(scene, camera));
                composer.addPass(bloom);
            }
        }

        // åˆ›å»ºçº¹ç†ï¼ˆç§»åŠ¨ç«¯ä½¿ç”¨æ›´å°çš„çº¹ç†ï¼‰
        function createTextures() {
            const canvasSize = isMobile ? 64 : 128;
            const canvas = document.createElement('canvas'); 
            canvas.width = canvasSize; 
            canvas.height = canvasSize;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvasSize,canvasSize);
            ctx.fillStyle = '#aa0000'; ctx.beginPath();
            for(let i=-canvasSize; i<canvasSize*2; i+=canvasSize/4) { 
                ctx.moveTo(i, 0); 
                ctx.lineTo(i+canvasSize/4, canvasSize); 
                ctx.lineTo(i+canvasSize/8, canvasSize); 
                ctx.lineTo(i-canvasSize/8, 0); 
            }
            ctx.fill();
            caneTexture = new THREE.CanvasTexture(canvas);
            caneTexture.colorSpace = THREE.SRGBColorSpace;
            caneTexture.wrapS = THREE.RepeatWrapping; 
            caneTexture.wrapT = THREE.RepeatWrapping;
            caneTexture.repeat.set(3, 3);

            const snowCvs = document.createElement('canvas'); 
            snowCvs.width = isMobile ? 16 : 32; 
            snowCvs.height = isMobile ? 16 : 32;
            const sCtx = snowCvs.getContext('2d');
            const grad = sCtx.createRadialGradient(
                snowCvs.width/2, snowCvs.width/2, 0, 
                snowCvs.width/2, snowCvs.width/2, snowCvs.width/2
            );
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            sCtx.fillStyle = grad; 
            sCtx.fillRect(0,0,snowCvs.width,snowCvs.height);
            snowTexture = new THREE.CanvasTexture(snowCvs);

            const hCvs = document.createElement('canvas'); 
            hCvs.width = isMobile ? 32 : 64; 
            hCvs.height = isMobile ? 32 : 64;
            const hCtx = hCvs.getContext('2d');
            hCtx.fillStyle = '#ffffff';
            hCtx.beginPath();
            hCtx.moveTo(hCvs.width/2, hCvs.height*0.3125);
            hCtx.bezierCurveTo(
                hCvs.width/2, hCvs.height*0.2656,
                hCvs.width*0.3125, hCvs.height*0.1563,
                hCvs.width*0.1563, hCvs.height*0.1563
            );
            hCtx.bezierCurveTo(
                hCvs.width*0.1563, hCvs.height*0.1563,
                hCvs.width*0.1563, hCvs.height*0.3906,
                hCvs.width*0.1563, hCvs.height*0.3906
            );
            hCtx.bezierCurveTo(
                hCvs.width*0.1563, hCvs.height*0.5469,
                hCvs.width*0.3125, hCvs.height*0.6563,
                hCvs.width/2, hCvs.height*0.8594
            );
            hCtx.bezierCurveTo(
                hCvs.width*0.6875, hCvs.height*0.6563,
                hCvs.width*0.8438, hCvs.height*0.5469,
                hCvs.width*0.8438, hCvs.height*0.3906
            );
            hCtx.bezierCurveTo(
                hCvs.width*0.8438, hCvs.height*0.3906,
                hCvs.width*0.8438, hCvs.height*0.1563,
                hCvs.width*0.6875, hCvs.height*0.1563
            );
            hCtx.bezierCurveTo(
                hCvs.width*0.5625, hCvs.height*0.1563,
                hCvs.width/2, hCvs.height*0.2656,
                hCvs.width/2, hCvs.height*0.3125
            );
            hCtx.fill();
            heartTexture = new THREE.CanvasTexture(hCvs);
        }

        // ...ï¼ˆä¸­é—´éƒ¨åˆ†çš„å‡½æ•°ä¿æŒä¸å˜ï¼Œä½†ä¼šåœ¨ç§»åŠ¨ç«¯è¿›è¡Œä¼˜åŒ–ï¼‰...

        // ä¿®æ”¹ï¼šç§»åŠ¨ç«¯ä¼˜åŒ–çš„ç²’å­æ›´æ–°
        class Particle {
            constructor(mesh, type, isDust = false) {
                this.mesh = mesh; 
                this.type = type; 
                this.isDust = isDust;
                this.posTree = new THREE.Vector3(); 
                this.posScatter = new THREE.Vector3();
                this.baseScale = mesh.scale.x; 
                this.offset = Math.random() * 100; 
                this.speed = 0.5 + Math.random();
                this.updateCount = 0; // ç”¨äºåˆ†å¸§æ›´æ–°
                
                if (mesh.material && mesh.material.emissive) { 
                    this.baseEmissive = mesh.material.emissive.clone(); 
                    this.hasEmissive = true; 
                }
                this.calculatePositions();
            }

            calculatePositions() {
                // ...ï¼ˆä¿æŒä¸å˜ï¼‰...
            }

            update(dt, time, mode, focusTargetMesh, invMatrix) {
                // ç§»åŠ¨ç«¯åˆ†å¸§æ›´æ–°ï¼šæ¯5å¸§æ›´æ–°ä¸€æ¬¡éç„¦ç‚¹ç²’å­
                if (isMobile && mode !== 'FOCUS' && this.updateCount++ % 5 !== 0) {
                    return;
                }
                
                // ...ï¼ˆåŸæœ‰çš„æ›´æ–°é€»è¾‘ï¼‰...
            }
        }

        // ä¿®æ”¹ï¼šç§»åŠ¨ç«¯ä¼˜åŒ–çš„åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.05); // é™åˆ¶æœ€å¤§deltaæ—¶é—´
            STATE.time = clock.elapsedTime;
            const inputX = STATE.hand.detected ? STATE.hand.x : 0; 

            // è®¡ç®—FPSï¼ˆä»…è°ƒè¯•ç”¨ï¼‰
            STATE.frameCount++;
            if (STATE.time - STATE.lastFpsTime > 1) {
                STATE.fps = STATE.frameCount;
                STATE.frameCount = 0;
                STATE.lastFpsTime = STATE.time;
                // å¦‚æœFPSè¿‡ä½ï¼ŒåŠ¨æ€è°ƒæ•´è´¨é‡
                if (isMobile && STATE.fps < 30) {
                    adjustQualityForPerformance();
                }
            }

            // ...ï¼ˆåŸæœ‰çš„åŠ¨ç”»é€»è¾‘ï¼Œä½†æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸æ§åˆ¶ï¼‰...
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸æ§åˆ¶
            if (isMobile && !STATE.hand.detected && STATE.touchRotating) {
                STATE.rotation.y += STATE.touchVelocity.y * dt * 2;
                STATE.rotation.x += STATE.touchVelocity.x * dt;
                // é€æ¸å‡é€Ÿ
                STATE.touchVelocity.x *= 0.95;
                STATE.touchVelocity.y *= 0.95;
            }

            // ...ï¼ˆåŸæœ‰çš„æ›´æ–°é€»è¾‘ï¼‰...

            // æ¸²æŸ“
            if (composer && !isMobile) {
                composer.render();
            } else {
                renderer.render(scene, camera);
            }
        }

        // æ–°å¢ï¼šç§»åŠ¨ç«¯æ€§èƒ½è°ƒæ•´
        function adjustQualityForPerformance() {
            // åŠ¨æ€é™ä½è´¨é‡
            if (STATE.fps < 20) {
                // ä¸¥é‡å¡é¡¿ï¼Œå¤§å¹…é™ä½è´¨é‡
                renderer.setPixelRatio(1.0);
                if (composer) composer.setPixelRatio(1.0);
                scene.fog.density *= 0.8;
            } else if (STATE.fps < 30) {
                // è½»å¾®å¡é¡¿ï¼Œé€‚åº¦é™ä½è´¨é‡
                const currentPR = renderer.getPixelRatio();
                if (currentPR > 1.0) {
                    renderer.setPixelRatio(currentPR * 0.8);
                    if (composer) composer.setPixelRatio(currentPR * 0.8);
                }
            }
        }

        // æ–°å¢ï¼šç§»åŠ¨ç«¯æ‘„åƒå¤´æƒé™å¤„ç†
        async function setupMediaPipeWithPermission() {
            try {
                // ç§»åŠ¨ç«¯éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½è¯·æ±‚æ‘„åƒå¤´æƒé™
                if (isMobile) {
                    // å…ˆæ˜¾ç¤ºæç¤º
                    showMobileAlert("ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®å¼€å§‹æ‰‹åŠ¿è¯†åˆ«", 3000);
                    
                    // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»
                    const startHandler = () => {
                        document.removeEventListener('click', startHandler);
                        document.removeEventListener('touchstart', startHandler);
                        initMediaPipe();
                    };
                    
                    document.addEventListener('click', startHandler);
                    document.addEventListener('touchstart', startHandler);
                } else {
                    // æ¡Œé¢ç«¯ç›´æ¥åˆå§‹åŒ–
                    await initMediaPipe();
                }
            } catch (error) {
                console.warn('MediaPipeåˆå§‹åŒ–å¤±è´¥:', error);
                showMobileAlert("æ‰‹åŠ¿è¯†åˆ«ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨è§¦æ‘¸æ§åˆ¶", 5000);
                
                // å¯ç”¨è§¦æ‘¸æ§åˆ¶
                setupTouchControls();
            }
        }

        // ä¿®æ”¹ï¼šä¼˜åŒ–åçš„æ‰‹åŠ¿è¯†åˆ«
        function processGestures(lm) {
            STATE.hand.detected = true;
            if (STATE.mode === 'LETTER') return;

            const dist = (i, j) => Math.hypot(lm[i].x - lm[j].x, lm[i].y - lm[j].y);
            const dIndex = dist(8,0), dMiddle = dist(12,0), dRing = dist(16,0), dPinky = dist(20,0);
            const palmSize = dist(0, 9);
            
            // å½“å‰æ‰‹æŒä½ç½®
            const currentPalmX = lm[9].x;
            const currentPalmY = lm[9].y;
            
            // 1. OKæ‰‹åŠ¿ï¼ˆä¹¦ä¿¡æ¨¡å¼ï¼‰
            if (dist(4,8) < 0.05 && dMiddle > 0.15 && dMiddle > dIndex * 1.2) {
                if (STATE.letterContent && STATE.letterContent.trim() !== "") {
                    if (Date.now() - STATE.letterLastTriggerTime > 1000) { 
                        STATE.letterLastTriggerTime = Date.now(); 
                        enterLetterMode(); 
                    }
                }
                STATE.gestureStartTime = 0;
                return;
            }
            
            // 2. ç«–èµ·æ‹‡æŒ‡æ‰‹åŠ¿ï¼ˆé¢œè‰²åˆ‡æ¢ï¼‰
            const isThumbExtended = dist(4, 9) > palmSize * 0.85; 
            const isIndexCurled = dist(8, 9) < palmSize * 0.65;  
            const isMiddleCurled = dist(12, 9) < palmSize * 0.65; 
            const isRingCurled = dist(16, 9) < palmSize * 0.65;  
            const isPinkyCurled = dist(20, 9) < palmSize * 0.65;
            
            const isThumbsUpGesture = isThumbExtended && isIndexCurled && isMiddleCurled && isRingCurled && isPinkyCurled;
            
            if (isThumbsUpGesture) {
                if (!STATE.gestureStartTime) {
                    STATE.gestureStartTime = Date.now();
                } else if (Date.now() - STATE.gestureStartTime > CONFIG.gestures.holdDuration) {
                    if (STATE.isGestureSwitchEnabled && Date.now() - STATE.gestureDebounceTimer > CONFIG.gestures.switchCooldown) { 
                        switchTheme((STATE.currentThemeIndex + 1) % 3); 
                        STATE.gestureDebounceTimer = Date.now();
                        STATE.gestureStartTime = 0;
                        // ç§»åŠ¨ç«¯è§†è§‰åé¦ˆ
                        if (isMobile) {
                            showMobileAlert("ä¸»é¢˜å·²åˆ‡æ¢", 1500);
                        }
                    }
                }
                return;
            } else {
                STATE.gestureStartTime = 0;
            }
            
            // 3. æ‰‹æŒç§»åŠ¨é€Ÿåº¦æ£€æµ‹
            let palmSpeed = 0;
            if (STATE.lastPalmPosition) {
                const dx = currentPalmX - STATE.lastPalmPosition.x;
                const dy = currentPalmY - STATE.lastPalmPosition.y;
                palmSpeed = Math.sqrt(dx*dx + dy*dy);
            }
            STATE.lastPalmPosition = {x: currentPalmX, y: currentPalmY};
            
            // 4. å¼ å¼€æ‰‹æŒï¼ˆæ•£å°„æ¨¡å¼ï¼‰
            const avgSpread = (dIndex+dMiddle+dRing+dPinky)/4;
            const isPalmOpen = avgSpread > CONFIG.gestures.palmOpenThreshold;
            const areFourFingersOpen = (dIndex > palmSize * 1.3) && 
                                     (dMiddle > palmSize * 1.3) && 
                                     (dRing > palmSize * 1.3) && 
                                     (dPinky > palmSize * 1.3);
            
            // å•æŒ‡æŒ‡å‘æ£€æµ‹
            const isPointing = dIndex > 0.1 && dMiddle < dIndex*0.7 && dRing < dIndex*0.7;
            
            if (isPointing) { 
                STATE.mode = 'FOCUS';
                if (!STATE.wasPointing) {
                    const photos = particleSystem.filter(p => p.type === 'PHOTO');
                    STATE.focusTarget = photos.length ? photos[(++STATE.currentPhotoIndex)%photos.length].mesh : STATE.starMesh;
                }
                STATE.wasPointing = true;
                STATE.hasPalmCenter = false;
                STATE.spinVel.x *= 0.9;
                STATE.spinVel.y *= 0.9;
            } else if (isPalmOpen && areFourFingersOpen && palmSpeed < CONFIG.gestures.palmSpeedThreshold) {
                STATE.mode = 'SCATTER';
                if (!STATE.hasPalmCenter) {
                    STATE.palmCenter = {x: currentPalmX, y: currentPalmY};
                    STATE.hasPalmCenter = true;
                    STATE.gestureBaseSpread = avgSpread;
                    STATE.scatterScale = 1.0;
                }
                
                if (STATE.gestureBaseSpread) {
                    STATE.scatterScale += (THREE.MathUtils.clamp(Math.pow(STATE.gestureBaseSpread/avgSpread, 2), 0.1, 5.0) - STATE.scatterScale) * 0.15;
                }
                
                const gain = CONFIG.gestures.sensitivity;
                const dx = currentPalmX - STATE.palmCenter.x;
                const dy = currentPalmY - STATE.palmCenter.y;
                STATE.spinVel.x += (THREE.MathUtils.clamp(-dy*gain, -3, 3) - STATE.spinVel.x) * 0.2;
                STATE.spinVel.y += (THREE.MathUtils.clamp(dx*gain, -3, 3) - STATE.spinVel.y) * 0.2;
                
                STATE.wasPointing = false;
            } else {
                STATE.mode = 'TREE';
                STATE.wasPointing = false;
                STATE.hasPalmCenter = false;
                STATE.scatterScale = 1.0;
                STATE.spinVel.x *= 0.9;
                STATE.spinVel.y *= 0.9;
            }
            
            // æ›´æ–°æ‰‹éƒ¨ä½ç½®
            STATE.hand.x += ((currentPalmX - 0.5)*3.0 - STATE.hand.x) * 0.1;
            STATE.hand.y += ((currentPalmY - 0.5)*3.0 - STATE.hand.y) * 0.1;
        }

        // æ–°å¢ï¼šç§»åŠ¨ç«¯è§¦æ‘¸æ§åˆ¶
        function setupTouchControls() {
            const touchLeft = document.getElementById('touch-left');
            const touchRight = document.getElementById('touch-right');
            
            touchLeft.style.opacity = '0.3';
            touchRight.style.opacity = '0.3';
            
            let touchStartTime = 0;
            let lastTouchX = 0;
            let lastTouchY = 0;
            let touchInterval = null;
            
            // è§¦æ‘¸å¼€å§‹
            const touchStart = (e) => {
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                STATE.touchStartX = touch.clientX;
                STATE.touchStartY = touch.clientY;
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
                touchStartTime = Date.now();
                STATE.touchRotating = true;
                
                // æ¸…é™¤ä¹‹å‰çš„å‡é€Ÿ
                STATE.touchVelocity.x = 0;
                STATE.touchVelocity.y = 0;
                
                // é•¿æŒ‰æ£€æµ‹ï¼ˆåˆ‡æ¢ä¸»é¢˜ï¼‰
                touchInterval = setTimeout(() => {
                    if (STATE.isGestureSwitchEnabled && Date.now() - STATE.gestureDebounceTimer > 2000) {
                        switchTheme((STATE.currentThemeIndex + 1) % 3);
                        STATE.gestureDebounceTimer = Date.now();
                        showMobileAlert("ä¸»é¢˜å·²åˆ‡æ¢", 1500);
                    }
                }, 500);
            };
            
            // è§¦æ‘¸ç§»åŠ¨
            const touchMove = (e) => {
                if (!STATE.touchRotating) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                
                const deltaX = touch.clientX - lastTouchX;
                const deltaY = touch.clientY - lastTouchY;
                
                // æ›´æ–°æ—‹è½¬é€Ÿåº¦
                STATE.touchVelocity.y = deltaX * 0.05;
                STATE.touchVelocity.x = deltaY * 0.02;
                
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
                
                // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                clearTimeout(touchInterval);
            };
            
            // è§¦æ‘¸ç»“æŸ
            const touchEnd = (e) => {
                e.preventDefault();
                STATE.touchRotating = false;
                clearTimeout(touchInterval);
                
                // åŒå‡»æ£€æµ‹ï¼ˆä¹¦ä¿¡æ¨¡å¼ï¼‰
                if (Date.now() - touchStartTime < 300) {
                    if (STATE.letterContent && STATE.letterContent.trim() !== "") {
                        enterLetterMode();
                    }
                }
            };
            
            // ç»‘å®šäº‹ä»¶
            const bindTouchEvents = (element) => {
                element.addEventListener('touchstart', touchStart, { passive: false });
                element.addEventListener('touchmove', touchMove, { passive: false });
                element.addEventListener('touchend', touchEnd, { passive: false });
                element.addEventListener('touchcancel', touchEnd, { passive: false });
                
                // é¼ æ ‡äº‹ä»¶ä½œä¸ºå¤‡ç”¨
                element.addEventListener('mousedown', touchStart);
                element.addEventListener('mousemove', touchMove);
                element.addEventListener('mouseup', touchEnd);
                element.addEventListener('mouseleave', touchEnd);
            };
            
            bindTouchEvents(touchLeft);
            bindTouchEvents(touchRight);
        }

        // æ–°å¢ï¼šç§»åŠ¨ç«¯æç¤ºå‡½æ•°
        function showMobileAlert(message, duration = 3000) {
            const alertEl = document.getElementById('mobile-alert');
            alertEl.textContent = message;
            alertEl.style.display = 'block';
            alertEl.style.opacity = '1';
            
            setTimeout(() => {
                alertEl.style.opacity = '0';
                setTimeout(() => {
                    alertEl.style.display = 'none';
                }, 500);
            }, duration);
        }

        // æ–°å¢ï¼šæ‰‹åŠ¿æ•™ç¨‹
        function showGestureTutorial() {
            const tutorial = document.getElementById('gesture-tutorial');
            tutorial.style.display = 'flex';
            
            document.getElementById('close-tutorial').onclick = () => {
                tutorial.style.display = 'none';
                localStorage.setItem('tutorialShown', 'true');
            };
        }

        // ä¿®æ”¹ï¼šäº‹ä»¶è®¾ç½®ï¼Œæ·»åŠ ç§»åŠ¨ç«¯é€‚é…
        function setupEvents() {
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => { 
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
                if (composer) composer.setSize(window.innerWidth, window.innerHeight); 
                
                // æ£€æµ‹æ¨ªç«–å±
                STATE.isLandscape = window.innerWidth > window.innerHeight;
                
                // ç§»åŠ¨ç«¯è°ƒæ•´UI
                if (isMobile) {
                    adjustUIForMobile();
                }
            });
            
            // é˜²æ­¢ç§»åŠ¨ç«¯ç¼©æ”¾
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('gesturechange', (e) => e.preventDefault());
            document.addEventListener('gestureend', (e) => e.preventDefault());
            
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd < 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // ç§»åŠ¨ç«¯UIè°ƒæ•´
            if (isMobile) {
                adjustUIForMobile();
                
                // ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡»åé¦ˆ
                const buttons = document.querySelectorAll('.control-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('touchstart', () => {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.backgroundColor = 'rgba(212, 175, 55, 0.3)';
                    });
                    
                    btn.addEventListener('touchend', () => {
                        btn.style.transform = '';
                        btn.style.backgroundColor = '';
                    });
                });
            }
            
            // ...ï¼ˆåŸæœ‰çš„äº‹ä»¶ç»‘å®šä»£ç ï¼‰...
        }

        // æ–°å¢ï¼šç§»åŠ¨ç«¯UIè°ƒæ•´
        function adjustUIForMobile() {
            // æ ¹æ®å±å¹•æ–¹å‘è°ƒæ•´UI
            if (STATE.isLandscape) {
                // æ¨ªå±æ¨¡å¼
                document.getElementById('top-right-controls').style.flexDirection = 'row';
                document.getElementById('col-media').style.flexDirection = 'column';
                document.getElementById('col-system').style.flexDirection = 'column';
            } else {
                // ç«–å±æ¨¡å¼
                document.getElementById('top-right-controls').style.flexDirection = 'column';
                document.getElementById('col-media').style.flexDirection = 'column';
                document.getElementById('col-system').style.flexDirection = 'column';
            }
            
            // è°ƒæ•´æ‘„åƒå¤´é¢„è§ˆä½ç½®
            const webcamWrapper = document.getElementById('webcam-wrapper');
            if (STATE.isLandscape) {
                webcamWrapper.style.bottom = '20px';
                webcamWrapper.style.right = '20px';
            } else {
                webcamWrapper.style.bottom = '80px';
                webcamWrapper.style.right = '20px';
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>